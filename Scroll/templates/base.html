{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{% endblock title %}</title>

    {% include "components/Favicons.html" %}
    
    <link rel="stylesheet" href="{% static "css/output.css" %}">
    
    <link
      href="{% static 'fontawesomefree/css/all.min.css' %}"
      rel="stylesheet"
      type="text/css"
    />


    {% block links %} {% endblock links %}
  </head>

  <body class="w-full h-full flex bg-black relative">
    <div 
        class="w-[18%] h-screen py-10 px-8 flex flex-col border-r border-[#262626] text-[#f5f5f5] fixed max-xl:w-[10%] max-xl:px-0max-xl:px-0     max-xl:items-center max-md:hidden"
    >
      {% include "components/SideBar.html" %}
    </div>

    {% include "components/WidgetBar.html" %}

    <div class="w-[82%] h-fit flex text-white absolute right-0 max-xl:w-[90%] max-md:w-full">    
      {% block body %} 
      
      {% endblock body %}
    </div>

    {% comment %} <script src="{% static 'js/tailwindcdn.js' %}"></script> {% endcomment %}
    <script src="{% static 'fontawesomefree/js/all.min.js' %}"></script>
    {% block scripts %} {% endblock scripts %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"
        integrity="sha512-tE1z+95+lMCGwy+9PnKgUSIeHhvioC9lMlI7rLWU0Ps3XTdjRygLcy4mLuL0JAoK4TLdQEyP0yOl/9dMOqpH/Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- To get notifications data -->
    <script type="module">

      async function check_notifications() {
        
        let res = await fetch("{% url 'notifications' %}");
        res = await res.json();
        
        if (res.status === 200) {
          if (res.data.length) {
            if (res.data.length < 9) {
              chat_notification.style.display = 'block';
              chat_widget_notification.style.display = 'block';
              chat_notification.innerText = res.data.length;
              chat_widget_notification.innerText = res.data.length;
            }
            else {
              chat_notification.style.display = 'block';
              chat_widget_notification.style.display = 'block';
              chat_notification.innerHTML = '9<sup>+</sup>';
              chat_widget_notification.innerHTML = '9<sup>+</sup>';
            }
          }

        }

      }


      let roomIds = await fetch("{% url 'get_room_ids' %}");
      roomIds = await roomIds.json();

      const socket = io('ws://192.168.100.5:3000', { query: { roomIds: JSON.stringify(roomIds.data), username: '{{user.username}}' } });
      const chat_notification = document.getElementById('chat_notification');
      const chat_widget_notification = document.getElementById('chat_widget_notification');
      
      window.onload = await check_notifications();

      socket.on('notifications', async(data) => {
          const { username } = data;

            if (username !== "{{user.username}}") {
                setTimeout(async function() {
                  await check_notifications();
                }, 100);
            }

      });

    </script>

  </body>
</html>
